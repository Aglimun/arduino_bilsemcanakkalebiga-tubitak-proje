<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Arduino Veri Kayıt Simülasyonu (IndexedDB)</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #log-area { max-height: 400px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; margin-top: 15px; background-color: #f9f9f9; }
        .status { margin-bottom: 10px; padding: 10px; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .warning { background-color: #fff3cd; color: #856404; border-color: #ffeeba; }
        button { padding: 10px 15px; cursor: pointer; }
    </style>
</head>
<body>

    <h1>Arduino Veri Kayıt Simülasyonu</h1>
    
    <p>
        **Maksimum Depolama Limiti:** 150 MB (yaklaşık 157,286,400 Bayt)
    </p>

    <div class="status warning" id="status-display">IndexedDB başlatılıyor...</div>

    <button onclick="simulateAndStoreData()">Yeni Veri Ekle ve Kontrol Et (Simülasyon)</button>
    <button onclick="displayAllData()">Tüm Kayıtları Yenile</button>

    <h2>Kayıtlar</h2>
    <div id="log-area">Veriler buraya yüklenecek...</div>

    <script>
        // Sabitler
        const DB_NAME = 'ProjectDataLogger';
        const DB_VERSION = 1;
        const STORE_NAME = 'LogEntries';
        // 150 MB = 150 * 1024 * 1024 = 157,286,400 bytes
        const MAX_STORAGE_BYTES = 157286400; 

        let db;
        const statusDisplay = document.getElementById('status-display');
        const logArea = document.getElementById('log-area');

        // --- IndexedDB Başlatma ---
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = (event) => {
                    statusDisplay.textContent = `Hata: IndexedDB açılamadı. Tarayıcınız desteklemiyor veya izin yok.`;
                    statusDisplay.className = 'status warning';
                    reject('Database error: ' + event.target.errorCode);
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    statusDisplay.textContent = `IndexedDB hazır. Veri tabanı açıldı.`;
                    statusDisplay.className = 'status success';
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        // "id" alanı otomatik artan primary key, "timestamp" ise sıralama için kullanılacak.
                        const store = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                        store.createIndex('timestamp', 'timestamp', { unique: false });
                    }
                };
            });
        }

        // --- Depolama Boyutunu Hesaplama (Basitleştirilmiş) ---
        async function calculateCurrentSize(transaction) {
            return new Promise(async (resolve, reject) => {
                const tx = transaction || db.transaction(STORE_NAME, 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const request = store.openCursor();
                
                let totalSize = 0;

                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        // Veriyi JSON string'ine çevirip uzunluğunu alarak boyut simülasyonu
                        const dataSize = JSON.stringify(cursor.value).length;
                        totalSize += dataSize;
                        cursor.continue();
                    } else {
                        resolve(totalSize);
                    }
                };

                request.onerror = (event) => {
                    reject('Boyut hesaplanırken hata: ' + event.target.errorCode);
                };
            });
        }

        // --- FIFO (İlk Giren İlk Çıkar) Silme Mantığı ---
        async function enforceSizeLimit(newEntrySize) {
            const tx = db.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            
            let currentSize = await calculateCurrentSize(tx);
            let sizeNeeded = (currentSize + newEntrySize) - MAX_STORAGE_BYTES;
            let deletedBytes = 0;
            let deletionCount = 0;

            if (sizeNeeded > 0) {
                // En eski (en küçük id'ye sahip) kayıtları silmek için bir cursor açıyoruz
                const request = store.openCursor();

                await new Promise((resolve, reject) => {
                    request.onsuccess = (event) => {
                        const cursor = event.target.result;
                        
                        if (cursor && sizeNeeded > 0) {
                            const entryId = cursor.value.id;
                            const entrySize = JSON.stringify(cursor.value).length;
                            
                            // Kaydı sil
                            store.delete(entryId).onsuccess = () => {
                                sizeNeeded -= entrySize;
                                deletedBytes += entrySize;
                                deletionCount++;
                                cursor.continue(); // Bir sonraki kayda geç
                            };
                            store.delete(entryId).onerror = reject;

                        } else {
                            resolve(); // İşlem bitti
                        }
                    };
                    request.onerror = reject;
                });

                console.log(`Limit aşıldı! ${deletionCount} adet en eski kayıt silindi. Tahmini silinen boyut: ${Math.round(deletedBytes / 1024)} KB`);
                statusDisplay.textContent = `UYARI: 150MB limit aşıldı! ${deletionCount} en eski kayıt silindi. Yeni kayıt eklenecek.`;
                statusDisplay.className = 'status warning';
            }
            
            // Son boyutu tekrar hesaplayıp kullanıcıya gösteriyoruz
            currentSize = await calculateCurrentSize();
            const currentSizeMB = (currentSize / 1048576).toFixed(2);
            logArea.prepend(document.createElement('br'));
            logArea.prepend(document.createTextNode(`[GÜNCEL DURUM] Depolama Boyutu: ${currentSizeMB} MB / 150 MB. Silinen Kayıt: ${deletionCount}`));

        }

        // --- Yeni Veri Oluşturma ve Ekleme ---
        async function simulateAndStoreData() {
            if (!db) {
                statusDisplay.textContent = "Veritabanı henüz hazır değil. Lütfen bekleyin.";
                return;
            }

            // Simüle edilmiş bir veri paketi oluştur
            const simulatedData = {
                timestamp: new Date().toISOString(),
                // Örnek sensör verisi: Sıcaklık, Nem, Basınç (Rastgele değerler)
                temperature: (Math.random() * 20 + 20).toFixed(2), 
                humidity: (Math.random() * 40 + 40).toFixed(2),
                pressure: (Math.random() * 500 + 950).toFixed(2),
                // Boyutu artırmak için rastgele büyük bir metin ekle (1 KB'tan biraz fazla)
                dummyPayload: 'X'.repeat(Math.floor(Math.random() * 1024) + 50) 
            };
            
            const newEntrySize = JSON.stringify(simulatedData).length;

            try {
                // 1. Boyut kontrolü ve FIFO silme işlemi
                await enforceSizeLimit(newEntrySize);

                // 2. Yeni veriyi ekleme
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                
                const request = store.add(simulatedData);

                request.onsuccess = () => {
                    const currentSizeMB = (newEntrySize / 1048576).toFixed(6);
                    statusDisplay.textContent = `Yeni kayıt (ID: ${request.result}) başarıyla eklendi. Tahmini boyut: ${currentSizeMB} MB`;
                    statusDisplay.className = 'status success';
                    displayAllData(); // Verileri yeniden yükle
                };

                request.onerror = (event) => {
                    statusDisplay.textContent = `Kayıt eklenirken hata: ${event.target.error}`;
                    statusDisplay.className = 'status warning';
                    console.error("Kayıt ekleme hatası:", event.target.error);
                };
            } catch (error) {
                console.error("Genel işlem hatası:", error);
            }
        }

        // --- Verileri Görüntüleme ---
        function displayAllData() {
            if (!db) return;

            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const request = store.openCursor(null, 'prev'); // En son ekleneni başta göstermek için ters sıra

            let html = '';
            let count = 0;

            request.onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor) {
                    const data = cursor.value;
                    const dataSizeKB = (JSON.stringify(data).length / 1024).toFixed(2);
                    html += `
                        <p>
                            <strong>ID:</strong> ${data.id} | 
                            <strong>Zaman:</strong> ${new Date(data.timestamp).toLocaleTimeString()} | 
                            <strong>Sıcaklık:</strong> ${data.temperature}°C | 
                            <strong>Nem:</strong> ${data.humidity}% | 
                            <strong>Boyut:</strong> ${dataSizeKB} KB
                        </p>
                    `;
                    count++;
                    cursor.continue();
                } else {
                    logArea.innerHTML = html || 'Henüz bir kayıt yok.';
                    calculateCurrentSize().then(size => {
                        const currentSizeMB = (size / 1048576).toFixed(2);
                        logArea.insertAdjacentHTML('afterbegin', `
                            <p><strong>Toplam Kayıt Sayısı: ${count}</strong> | <strong>Tahmini Toplam Boyut: ${currentSizeMB} MB</strong></p>
                            <hr>
                        `);
                    });
                }
            };

            request.onerror = () => {
                logArea.innerHTML = 'Veriler yüklenirken bir hata oluştu.';
            };
        }

        // Sayfa yüklendiğinde veritabanını başlat
        openDB().then(displayAllData);

    </script>

</body>
</html>
