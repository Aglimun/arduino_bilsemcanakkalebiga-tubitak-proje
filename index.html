<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Arduino SensÃ¶r Dashboardu | RAM Bellek & Grafik</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
    /* GENEL STÄ°L VE FONT */
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap');
    :root {
        /* AÃ§Ä±k Tema */
        --bg-primary: #f8f9fa; 
        --bg-secondary: #ffffff;
        --text-color: #212529; 
        --text-muted: #6c757d;
        --card-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        --accent-color: #007bff; 
        --border-color: #e9ecef;
    }
    .dark-mode {
        /* Koyu Tema */
        --bg-primary: #121212; 
        --bg-secondary: #1f1f1f; 
        --text-color: #e0e0e0; 
        --text-muted: #a0a0a0;
        --card-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        --accent-color: #28a745; 
        --border-color: #333333;
    }

    body { 
        font-family: 'Poppins', sans-serif; 
        background: var(--bg-primary); 
        margin: 0; 
        padding: 30px; 
        color: var(--text-color);
        transition: background-color 0.4s ease, color 0.4s ease;
    }

    /* HEADER VE BUTONLAR */
    .header {
        display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px;
    }
    h1 { margin: 0; color: var(--text-color); font-weight: 700; font-size: 1.8em; }
    .action-buttons button {
        padding: 12px 25px; font-size: 14px; border: none;
        border-radius: 50px; 
        cursor: pointer; transition: background-color 0.3s, transform 0.2s;
        box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        font-weight: 600;
    }
    .action-buttons button:active {
        transform: scale(0.98);
    }
    #connect { 
        background-color: var(--accent-color); 
        color: var(--bg-secondary); 
        margin-right: 15px; 
    }
    #connect:hover { 
        background-color: color-mix(in srgb, var(--accent-color) 90%, black);
    }
    #modeToggle { 
        background-color: var(--bg-secondary); 
        color: var(--text-color); 
        border: 1px solid var(--border-color);
        box-shadow: none;
    }
    #modeToggle:hover { 
        background-color: var(--border-color); 
    }
    .dark-mode #modeToggle {
        border-color: var(--border-color);
    }

    /* KART VE DÃœZEN */
    .dashboard-grid {
        display: grid;
        grid-template-columns: 3fr 1fr; 
        gap: 30px;
        max-width: 1400px; 
        margin: 0 auto;
    }
    .card-container { display: flex; gap: 30px; margin-bottom: 30px; }
    .card { 
        background: var(--bg-secondary); padding: 30px; border-radius: 16px; 
        box-shadow: var(--card-shadow); 
        width: 100%; 
        transition: background-color 0.4s ease, box-shadow 0.4s ease;
        border: 1px solid transparent; 
    }
    .card:hover {
        border-color: var(--accent-color);
    }

    .card h3 { 
        margin: 0 0 15px; 
        color: var(--text-muted); 
        font-weight: 600; 
        font-size: 0.8em; 
        text-transform: uppercase; 
        letter-spacing: 1px;
    }
    .metric-value { 
        font-size: 3.2em; 
        font-weight: 800; 
        color: var(--text-color); 
        margin-top: 5px; 
        line-height: 1.1;
    }

    /* BARLAR VE DURUM GÃ–STERGELERÄ° */
    .bar-container { height: 6px; background: var(--border-color); border-radius: 3px; overflow: hidden; margin-top: 15px; }
    .bar-fill { height: 100%; transition: width 0.3s ease; }
    #soilBar { background-color: #28a745; } 
    #potBar { background-color: #ffc107; } 
    
    .status-info { 
        margin-top: 20px; 
        font-weight: 600; 
        display: flex; 
        align-items: center; 
        font-size: 0.9em;
    }
    .status-indicator {
        width: 12px; height: 12px; border-radius: 50%; margin-right: 10px;
        background: #dc3545; 
        box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
        transition: background-color 0.3s, box-shadow 0.3s;
    }
    #pump[data-status="1"] .status-indicator { 
        background: #28a745; 
        box-shadow: 0 0 10px rgba(40, 167, 69, 0.8); 
    }

    /* SICAKLIK LED DURUMU */
    .led-card .status-indicator { 
        width: 30px; 
        height: 30px; 
        margin-top: 15px; 
        display: block; 
    }
    .led-card.cold { border-left: 5px solid #007bff; }
    .led-card.cold .status-indicator { background: #007bff; box-shadow: 0 0 15px #007bff; }
    
    .led-card.warm { border-left: 5px solid #dc3545; }
    .led-card.warm .status-indicator { background: #dc3545; box-shadow: 0 0 15px #dc3545; }
    
    .led-card.normal { border-left: 5px solid #28a745; }
    .led-card.normal .status-indicator { background: #28a745; box-shadow: 0 0 15px #28a745; }

    /* YENÄ° EKLENEN KUTULAR Ä°Ã‡Ä°N STÄ°L */
    .chart-area { grid-column: 1 / 2; }
    .sidebar { grid-column: 2 / 3; display: flex; flex-direction: column; gap: 30px; }
    
    /* CHART STÄ°LÄ° */
    #chart-placeholder { height: 400px; } 
    #sensorChart { 
        background: var(--bg-secondary); 
    }

    /* SÄ°STEM Ã–ZETÄ° VE TAHMÄ°N KARTI STÄ°LLERÄ° */
    .sidebar .card {
        flex-grow: 1; 
    }
    #prediction-value { 
        font-size: 2em; 
        font-weight: 700; 
        line-height: 1.2;
    }
    .sidebar ul {
        list-style: none; padding: 0; 
        color: var(--text-color);
        font-size: 0.95em;
    }
    .sidebar li {
        padding: 10px 0;
        border-bottom: 1px solid var(--border-color);
    }
    .sidebar li:last-child {
        border-bottom: none;
    }
</style>
</head>
<body class="dark-mode">Â 

<div class="header">
Â  <h1>âš™ï¸ Arduino SensÃ¶r Dashboardu</h1>
Â  <div class="action-buttons">
Â  Â  <button id="connect">ğŸ”Œ BaÄŸlan</button>
Â  Â  <button id="modeToggle">â˜€ï¸ AÃ§Ä±k Tema</button>
Â  </div>
</div>

<div class="dashboard-grid">
Â  <div>
Â  Â  <div class="card-container">
Â  Â  Â  <div class="card">
Â  Â  Â  Â  <h3>ğŸ’§ TOPRAK NEMÄ°</h3>
Â  Â  Â  Â  <div id="soil" class="metric-value">0%</div>
Â  Â  Â  Â  <div class="bar-container"><div id="soilBar" class="bar-fill" style="width:0%"></div></div>
Â  Â  Â  Â  <div id="pump" data-status="0" class="status-info">
Â  Â  Â  Â  Â  <span class="status-indicator"></span> Pompa KapalÄ±
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â Â 
Â  Â  Â  <div class="card">
Â  Â  Â  Â  <h3>âš™ï¸ POTANSÄ°YOMETRE</h3>
Â  Â  Â  Â  <div id="pot" class="metric-value">0</div>
Â  Â  Â  Â  <div class="bar-container"><div id="potBar" class="bar-fill" style="width:0%"></div></div>
Â  Â  Â  Â  <div class="status-info" style="color: var(--text-muted);">0-1023 DeÄŸeri</div>
Â  Â  Â  </div>

Â  Â  Â  <div class="card led-card" id="temperature">
Â  Â  Â  Â  <h3>ğŸŒ¡ï¸ SICAKLIK</h3>
Â  Â  Â  Â  <div id="temp" class="metric-value">0Â°C</div>
Â  Â  Â  Â  <div class="status-info">
Â  Â  Â  Â  Â  Durum: Normal
Â  Â  Â  Â  Â  <div id="tempLed" class="status-indicator"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="card chart-area">
Â  Â  Â  <h3>ğŸ“ˆ TÃœM SENSÃ–R VERÄ°LERÄ° GEÃ‡MÄ°ÅÄ° (Son 20 Ã–lÃ§Ã¼m)</h3>
Â  Â  Â  <div id="chart-placeholder" style="height: 400px;">
Â  Â  Â  Â  <canvas id="sensorChart"></canvas>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <div class="sidebar">
Â  Â  <div class="card">
Â  Â  Â  <h3>â˜€ï¸ TAHMÄ°N / PROGNOZ</h3>
Â  Â  Â  <div class="metric-value" id="prediction-value">Veri bekleniyor...</div>
Â  Â  Â  <p style="color: var(--text-muted); font-size: 0.9em; margin-top: 10px;">
Â  Â  Â  Â  Mevcut SÄ±caklÄ±k verisine gÃ¶re durum tahmini yapÄ±lÄ±r.
Â  Â  Â  </p>
Â  Â  </div>

Â  Â  <div class="card">
Â  Â  Â  <h3>âœ… SÄ°STEM Ã–ZETÄ°</h3>
Â  Â  Â  <ul style="list-style: none; padding: 0; color: var(--text-color);">
Â  Â  Â  Â  <li style="color: #007bff; margin-bottom: 5px;">GeÃ§miÅŸ Veri: <span id="data-status">RAM Bellekte Tutuluyor</span></li>
Â  Â  Â  Â  <li style="color: #28a745; margin-bottom: 5px;">Pompa: **Otomatik Kontrol**</li>
Â  Â  Â  Â  <li style="color: var(--text-muted);">BaÄŸlantÄ±: **Bekleniyor**</li>
Â  Â  Â  </ul>
Â  Â  </div>
Â  </div>
</div>

<script>
// --- SABÄ°TLER VE DEÄÄ°ÅKENLER ---
let port;
let reader;
let buffer = "";Â 

const CHART_VISIBLE_POINTS = 20; // Grafikte gÃ¶sterilecek maksimum nokta sayÄ±sÄ±
const MAX_RAM_POINTS = 50000; // 150MB limiti yaklaÅŸÄ±k 50.000 veri noktasÄ±na denk gelir (Her veri noktasÄ± ~3KB varsayÄ±mÄ±yla).
// Bu kodda RAM limiti yerine sadece gÃ¶rsel amaÃ§lÄ± CHART_VISIBLE_POINTS kullanÄ±lacaktÄ±r.

// RAM Bellek Dizisi
let sensorHistory = []; 

// Grafik ve ArayÃ¼z DeÄŸiÅŸkenleri
let sensorChart;


// -----------------------------------------------------------
// 1. CHART.JS Ä°ÅLEMLERÄ°
// -----------------------------------------------------------

function initializeChart() {
    const ctx = document.getElementById('sensorChart').getContext('2d');
    sensorChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],Â 
            datasets: [{
                label: 'SÄ±caklÄ±k (Â°C)',
                data: [],
                borderColor: '#dc3545', // KÄ±rmÄ±zÄ±
                tension: 0.4, fill: false, yAxisID: 'yTemp'
            },
            {
                label: 'Nem (%)',
                data: [],
                borderColor: '#007bff', // Mavi
                tension: 0.4, fill: false, yAxisID: 'yNemPot'
            },
            {
                label: 'Potansiyometre (0-1023)',
                data: [],
                borderColor: '#ffc107', // SarÄ±
                tension: 0.4, fill: false, yAxisID: 'yNemPot'
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: {
                x: {
                    display: true, title: { display: true, text: 'Zaman' },
                    grid: { color: document.body.classList.contains('dark-mode') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' }
                },
                yTemp: {
                    type: 'linear', display: true, position: 'left',
                    title: { display: true, text: 'SÄ±caklÄ±k (Â°C)' },
                    grid: { color: document.body.classList.contains('dark-mode') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' }
                },
                yNemPot: {
                    type: 'linear', display: true, position: 'right',
                    title: { display: true, text: 'Nem/Pot (0-1023)' },
                    min: 0, max: 1023,
                    grid: { drawOnChartArea: false }
                }
            },
            plugins: {
                legend: { labels: { color: document.body.classList.contains('dark-mode') ? 'white' : 'black' } }Â 
            }
        }
    });
}

/** GrafiÄŸi RAM'deki sensorHistory dizisindeki verilerle gÃ¼nceller. */
function updateChartLive() {
    if (!sensorChart) return;

    // Tema renklerini al ve uygula
    const isDarkMode = document.body.classList.contains('dark-mode');
    const color = isDarkMode ? 'white' : 'black';
    const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

    sensorChart.options.scales.x.ticks = { color: color };
    sensorChart.options.scales.x.grid = { color: gridColor };
    sensorChart.options.scales.yTemp.ticks = { color: color };
    sensorChart.options.scales.yTemp.grid = { color: gridColor };
    sensorChart.options.scales.yNemPot.ticks = { color: color };
    sensorChart.options.plugins.legend.labels.color = color;


    // Sadece grafikte gÃ¶rÃ¼nmesi gereken son noktalarÄ± Ã§ek (CanlÄ± kayan pencere)
    const datasets = sensorChart.data.datasets;
    const latestHistory = sensorHistory.slice(-CHART_VISIBLE_POINTS);
    
    sensorChart.data.labels = latestHistory.map(d => d.time);
    datasets[0].data = latestHistory.map(d => d.sic);
    datasets[1].data = latestHistory.map(d => d.nem);
    datasets[2].data = latestHistory.map(d => d.pot);

    sensorChart.update();
}


// -----------------------------------------------------------
// 2. ARDUINO SERÄ° PORT Ä°ÅLEMLERÄ°
// -----------------------------------------------------------

document.getElementById("connect").addEventListener("click", async () => {
    if ("serial" in navigator) {
        try {
            port = await navigator.serial.requestPort();
            await port.open({ baudRate: 9600 });
            document.getElementById("connect").innerText = "BaÄŸlanÄ±ldÄ± (Veri Geliyor...)";
            document.querySelector('.sidebar li:last-child').innerHTML = 'BaÄŸlantÄ±: **Seri Port Aktif**';
            const textDecoder = new TextDecoderStream();
            port.readable.pipeTo(textDecoder.writable);
            reader = textDecoder.readable.getReader();
            readLoop();
        } catch (err) {
            alert("BaÄŸlantÄ± HatasÄ±: " + err);
        }
    } else {
        alert("TarayÄ±cÄ±nÄ±z Seri Port API'Ä±nÄ± desteklemiyor. (Sadece Chrome/Edge'de Ã§alÄ±ÅŸÄ±r.)");
    }
});

async function readLoop() {
    while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        if (value) {
            buffer += value;
            
            if (buffer.includes('\n')) {
                let lines = buffer.split('\n');
                buffer = lines.pop();Â 

                // Sadece en son geÃ§erli veriyi iÅŸleÂ 
                for (let i = lines.length - 1; i >= 0; i--) {
                    const line = lines[i].trim();
                    if (line.includes("nem:")) {
                        processLine(line);
                        break;Â 
                    }
                }
            }
        }
    }
}

// -----------------------------------------------------------
// 3. VERÄ° Ä°ÅLEME VE RAM'E KAYIT (BASÄ°TLEÅTÄ°RÄ°LMÄ°Å)
// -----------------------------------------------------------

function processLine(data) {
    try {
        const parts = data.split(';');
        let latestValues = {};Â 

        parts.forEach(part => {
            const [key, val] = part.split(':');
            if (key && val) latestValues[key] = parseFloat(val);
        });

        updateDashboard(latestValues);
        
        // TÃ¼m deÄŸerler varsa RAM'deki diziye kaydet ve grafiÄŸi canlÄ± gÃ¼ncelle
        if (latestValues.sic !== undefined && latestValues.nem !== undefined && latestValues.pot !== undefined) {
            const dataPoint = {Â 
                time: new Date().toLocaleTimeString(),Â 
                sic: latestValues.sic,
                nem: latestValues.nem,
                pot: latestValues.pot
            };
            
            // 1. Veriyi RAM'deki diziye ekle
            sensorHistory.push(dataPoint);Â 
            
            // 2. RAM'de tutulan tÃ¼m veri noktalarÄ±nÄ±n tahmini limitini yÃ¶net (isteÄŸe baÄŸlÄ±, performans iÃ§in)
            // if (sensorHistory.length > MAX_RAM_POINTS) {
            //     sensorHistory.shift(); // En eski veriyi sil (FIFO, ama RAM iÃ§in)
            // }

            // 3. Grafik verisini canlÄ± olarak gÃ¼ncelle
            updateChartLive();
            updatePrediction(dataPoint.sic);
        }

    } catch (e) {
        console.error("Veri iÅŸleme hatasÄ±:", e);
    }
}

// -----------------------------------------------------------
// 4. DASHBOARD VE TAHMÄ°N FONKSÄ°YONLARI (DEÄÄ°ÅMEDÄ°)
// -----------------------------------------------------------

function updateDashboard(values) {
    if (values.nem !== undefined) {
      document.getElementById("soil").innerText = values.nem + "%";
      document.getElementById("soilBar").style.width = values.nem + "%";
    }

    if (values.pump !== undefined) {
      const pumpEl = document.getElementById("pump");
      pumpEl.querySelector('span').nextSibling.textContent = values.pump ? " Pompa AÃ§Ä±k" : " Pompa KapalÄ±";
      pumpEl.setAttribute("data-status", values.pump ? "1" : "0");
    }

    if (values.sic !== undefined) {
      document.getElementById("temp").innerText = values.sic.toFixed(1) + "Â°C";
      const ledCard = document.getElementById("temperature");
      ledCard.classList.remove("warm", "cold", "normal");
      
      let statusText = "Normal";
      if (values.sic < 15) {
        ledCard.classList.add("cold");
        statusText = "SoÄŸuk";
      } else if (values.sic > 27) {
        ledCard.classList.add("warm");
        statusText = "SÄ±cak";
      } else {
        ledCard.classList.add("normal");
      }
      ledCard.querySelector('.status-info').firstChild.textContent = `Durum: ${statusText} `;
    }

    if (values.pot !== undefined) {
      document.getElementById("pot").innerText = values.pot;
      document.getElementById("potBar").style.width = (values.pot / 1023 * 100) + "%";
    }
}

function updatePrediction(currentTemp) {
    if (currentTemp === undefined || isNaN(currentTemp)) return;

    let predictionText = currentTemp.toFixed(1) + "Â°C";

    if (currentTemp > 25) {
          predictionText += " (YÃ¼ksek EÄŸilim)";
    } else if (currentTemp < 17) {
          predictionText += " (DÃ¼ÅŸÃ¼k EÄŸilim)";
    } else {
          predictionText += " (Stabil)";
    }

    document.getElementById("prediction-value").innerText = predictionText;
}


// -----------------------------------------------------------
// 5. DARK MODE VE BAÅLANGIÃ‡ AYARLARI
// -----------------------------------------------------------

document.getElementById('modeToggle').addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
    const isDarkMode = document.body.classList.contains('dark-mode');
    document.getElementById('modeToggle').textContent = isDarkMode ? 'â˜€ï¸ AÃ§Ä±k Tema' : 'ğŸŒ™ Koyu Tema';
    
    // Tema deÄŸiÅŸiminde grafiÄŸi de gÃ¼ncelle (renkler iÃ§in)
    updateChartLive();
});

document.addEventListener('DOMContentLoaded', () => {
    // Tema baÅŸlangÄ±Ã§ ayarÄ±
    const isDarkMode = document.body.classList.contains('dark-mode');
    document.getElementById('modeToggle').textContent = isDarkMode ? 'â˜€ï¸ AÃ§Ä±k Tema' : 'ğŸŒ™ Koyu Tema';
    
    // Grafik bileÅŸenini baÅŸlat
    initializeChart();
});
</script>

</body>
</html>
